  組込み向けファイルシステム（GR-FILE）Version 1.31　リリースノート

１．本リリースの内容

　本リリース　Version 1.31 は、Version 1.30のバグ修正です。
　本リリース、及び、Version 1.11以降の変更内容を以下に逆順で示します。

１.１　本リリースVersion 1.31 での変更内容

　Version 1.30に対し、以下のバグ修正を行いました。

（１）コンパイルエラー、誤記修正
　　　GRP_FS_MINIMIZE_LEVELを「2」とした場合にコンパイラにおいて
　　　ワーニングが発生していたことを修正しました。
　　　_fat_check_volume()内において行末の終端が「,」となっている
　　　部分を「;」に修正しました。

　　なお、以上の修正で、Version1.30に対して追加・変更したファイルは、
　以下のファイルです。その他のファイルは、Version1.30と同じです。

　　・src/grp_fs/base/
　　　　fat.c
　　・src/mdep_itron/base/
　　　　grp_fs_mdep_if.c
　　・src/mdep_vos/base/
　　　　grp_fs_mdep_if.c
　　・src/mdep_vos2.xx/base/
　　　　grp_fs_mdep_if.c
　　※サンプルアプリケーションの変更は上記に含まれません。

１.２　本リリースVersion 1.30 での変更内容

　Version 1.24に対し、以下の機能追加を行いました。

（１）2Gバイト以上のファイルサイズに対応
　　　ファイルサイズ2Gバイト以上、4G-1バイト以下に対応しました。
　　　コンパイルオプションGRP_FS_ENABLE_OVER_2Gを有効にすることで
　　大きなファイルの読み書きが可能になります。
　　　上記コンパイルオプションはデフォルトで有効です。

　　なお、以上の修正で、Version1.24に対して追加・変更したファイルは、
　以下のファイルです。その他のファイルは、Version1.24と同じです。

　　・src/grp_fs/base/
　　　　fat.c
　　　　fat.h
　　　　grp_fs.c
　　　　grp_fs_.h
　　　　grp_fs_conv_lib.c
　　　　grp_fs_readdir.c
　　・src/grp_fs/include/
　　　　grp_fs_conv.h
　　　　grp_fs_if.h
　　　　grp_fs_readdir.h
　　　　grp_fs_sysdef.h
　　　　grp_stdio.h
　　　　grp_types.h
　　・src/grp_fs/lib/grp_stdio/
　　　　grp_stdio_fflush.c
　　　　grp_stdio_fopen.c
　　　　grp_stdio_fseek4G.c
　　　　grp_stdio_ftell4G.c
　　※サンプルアプリケーションの変更は上記に含まれません。

１.３　本リリースVersion 1.24 での変更内容

　Version 1.23cに対し、以下のバグ修正を行いました。

（１）フォーマット計算時のクラスタ数の間違い
　　　grp_fat_find_type()を使用してフォーマットパラメータを算出した
　　場合に返される、grp_fat_format_param_t構造体のメンバの内、クラ
　　スタ数を示すuiClstの値が2多い値で返されていました。
　　　これを修正しました。
　　　grp_fat_find_type()は内部的にgrp_fat_format()、grp_fat_format
　　_sd()で使用されていますが、uiClstは計算結果のみでありフォーマット
　　、マウントの動作上は、正しいクラスタ数を使用しています。

　　Version1.23cに対して追加されたファイルは、以下のファイルです。

　　・src/grp_fs/base
　　　　grp_fat_format.c

１.４　本リリースVersion 1.23c での変更内容

　Version 1.23bに対し、以下の機能を追加しました。

（１）GR-VOS 2.xx依存ファイルの追加
　　　弊社製USBドライバ(GR-USB/HOST#)などで使用される GR-VOS 2.xxに
　　依存する処理を行う mdep_vos2.xx を追加しました。

　　なお、上記依存ファイルの追加以外では変更はありません。
　　Version1.23bに対して追加されたファイルは、以下のファイルです。

　　・src/mdep_vos2.xx/base/
　　　　grp_fs_dev_io.c
　　　　grp_fs_dev_sw_tbl.c
　　　　grp_fs_mdep_if.c
　　・src/mdep_vos2.xx/include/
　　　　grp_fs_mdep_types.h
　　　　grp_mdep_sem.h
　　・src/mdep_vos2.xx/lib/grp_mem/
　　　　grp_mem.c
　　・src/mdep_vos2.xx/lib/grp_sem/
　　　　grp_sem.c
　　・src/mdep_vos2.xx/lib/grp_time/
　　　　grp_time_get.c
　　　　grp_time_set.c

１.５　本リリースVersion 1.23b での変更内容

　Version 1.23aに対し、以下のバグ修正を行いました。

（１）クラスタキャッシュ取得時のループ条件修正
　　　FAT32においてフリークラスタキャッシュを取得する際にFSINFOのNext
　　Free値が３の場合、FAT領域外を検索する場合があるのを修正しました。

（２）リードオンリーマウント判定方法修正
　　　リードオンリーマウント時はフリークラスタキャッシュの取得を行ない
　　ませんが、この時のマウント方法の判定をビットのセット/リセットで判定
　　するところを値の一致で判定していました。
　　　これを修正しました。
　　　なお、マウント時のフリークラスタキャッシュ取得処理ではリードオンリ
　　マウントを示すビットのみが設定される為、動作に影響はありません。

（３）GRP_FS_MINIMIZE_LEVEL使用時のインクルードファイル修正
　　　GRP_FS_MINIMIZE_LEVELを２で使用した場合に、インクルードファイルが
　　読み込まれず、コンパイルエラーが発生する問題を修正しました。

　　なお、以上の修正で、Version1.23aに対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.23aと同じです。

　　・src/grp_fs/base/
　　　　fat.c
　　・src/grp_fs/lib/grp_char/
　　　　grp_char_sjis_conv.c

１.６　本リリースVersion 1.23a での変更内容

　Version 1.23に対し、以下のバグ修正を行いました。

（１）タイプキャストの修正
　　　_fat_match_comp()内でファイル名の比較を行なう関数へのパラメータ
　　のタイプキャストを修正しました。

（２）戻り値タイプの修正
　　　μITRON依存ファイルのgrp_fs_mdep_if.cにおいて、grp_fs_cmp_fname
　　の戻り値の型が間違っていたのを修正しました。

　　なお、以上の修正で、Version1.23に対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.23と同じです。

　　・src/grp_fs/base/
　　　　fat.c
　　・src/mdep_itron/base/
　　　　grp_fs_mdep_if.c

１.７　本リリースVersion 1.23 での変更内容

　Vesrion 1.22に対し、以下の改善を行いました。

（１）アクセス中で無いデバイスのアンマウント(GRFILE_0058)
　　　GR-FILEはタスクが1つでもGR-FILE中で処理中の場合は、たとえアク
　　セスを行っていないデバイスであってもアンマウントできませんでした。
　　　これを改善し、アクセス中で無いデバイスをアンマウントできる様に
　　改善するコンパイルスイッチを追加しました。

（２）アーカイブ属性が設定されない(GRFILE_0067)
　　　従来、grp_fs_set_attr()でのみ設定できたアーカイブ属性をファイル
　　の作成、書込み、名称変更時にセットする機能を追加しました。
　　　本機能はコンパイルスイッチを有効にした場合に動作します。

（３）ロング名付きショート名の生成速度改善オプション追加(GRFILE_0068)
　　　単一ディレクトリに似たようなロングファイル名が多数存在する場合
　　に、ロングファイル名付きショートファイル名の生成、重複確認の速度
　　改善を行う機能を追加しました。
　　　ロングファイル名付きショートファイル名の生成は似たようなロング
　　ファイル名が多数存在する場合、ショート名が重複しやすくなります。
　　　本改善では、重複が続いた場合に生成するショート名を変更する機能
　　です。
　　　本機能はコンパイルスイッチを有効にした場合に動作します。

　Version 1.22に対し、以下のバグ修正を行いました。

（１）ロング名付きショート名の生成でピリオドが複数あるとショート名が
　　短くなる(GRFILE_0063)
　　　ロングファイル名付きショート名を生成する際にロングファイル名に
　　複数のピリオドが存在すると生成されるショート名が短く生成される事
　　がある問題を修正しました。

（２）ロング名の大文字小文字を区別している(GRFILE_0064)
　　　ロングファイル名を指定する場合に、大文字小文字を区別している為
　　大文字小文字のみの違いでも別ファイルとして扱ってしまう問題を修正
　　しました。

　　なお、以上の修正で、Version1.22に対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.22と同じです。
　
　　・src/grp_fs/base/
　　　　fat.c
　　　　grp_fs.c
　　　　grp_fs.h
　　　　grp_fs_mdep_if.h
　　・src/grp_fs/include/
　　　　grp_char_conv.h
　　　　grp_fs_sysdef.h
　　　　grp_fs_dev_io_if.h
　　・src/grp_fs/lib/grp_char/
　　　　grp_char_sjis_conv.c
　　・src/mdep_itron/base/
　　　　grp_fs_mdep_if.c
　　・src/mdep_vos/base/
　　　　grp_fs_mdep_if.c

１.８　本リリースVersion 1.22 での変更内容

　Version 1.21に対し、以下のバグ修正を行いました。

（１）物理セクタサイズと異なる論理セクタサイズで正しくフォーマットが
　　出来ない（GRFILE_0023）
　　　物理セクタサイズと異なる論理セクタサイズを指定してフォーマット
　　を行うと、正常終了となるが実際には正常にフォーマット出来ていない
　　現象を修正しました。
　　　なお、物理セクタサイズと同じ論理セクタサイズを指定した場合は、
　　問題ありません。

（２）FSINFOのヒント情報が正しく記録されない（GRFILE_0027）
　　　FAT32のアンマウント時に書き込まれるフリークラスタのヒント情報が
　　いくつかのフリークラスタを飛ばした値となっていて、クラスタ割り当て
　　が飛び飛びになりやすい現象がありました。
　　　本現象を継続して使用すると性能劣化を起こしやすくなります。
　　　これを修正しました。

（３）GRP_FS_MAX_TASKを正しく設定していてもGRP_FS_ERR_TOO_MANYが発生
　　する場合がある（GRFILE_0029）
　　　同時アクセスしているタスク数がGRP_FS_MAX_TASK以下でも、GR-FILEに
　　対してアクセスしたタスク数がGRP_FS_MAX_TASKを超える場合、GRP_FS_ERR
　　_TOO_MANYエラーが発生する場合がありました。
　　　これは、GRP_FS_MAX_TASKの設定が「同時アクセス数」では無く「最大
　　アクセス数」で扱われていた為です。
　　　これを修正しました。

（４）壊れたファイルをダイレクトI/Oでリードしてもエラーにならない
　　（GRFILE_0030）
　　　FATの途中にEOC（End Of Cluster）を含む壊れたファイルに対しread
　　しても、ダイレクトI/Oモードのreadではエラーとならない場合がありま
　　した。
　　　これを修正しました

（５）ディレクトリエントリが壊れていた場合に検索が出来ない場合がある
　　（GRFILE_0031）
　　　ファイルシステム異常等で、ショート名と対応していない、浮いたロン
　　グ名がある状態で、浮いたロング名の検索をおこなった場合に、不正エン
　　トリをスキップし、次エントリの検索を継続して行う必要がありますが、
　　不正なロングエントリの次のエントリを取得する際に、ファイル名バッフ
　　ァのサイズを正しく設定していないため、次のエントリのファイル名を正
　　しく取得出来ない場合がありました。
　　　また、不正なロングエントリがディレクトリエントリキャッシュにある
　　場合、不正なロングエントリファイル名を指定すると、不正なロングエン
　　トリ以降のみを検索してしまうため、そのエントリより前に一致するエン
　　トリがあっても、検索できませんでした。
　　　これを修正しました。

（６）ディレクトリエントリが壊れていた場合に別のファイルと間違う場合が
　　ある（GRFILE_0032）
　　　ファイルシステム異常等で、ショート名と対応していない浮いたロング
　　名があり、浮いたロングエントリの後の、ショート名を指定した場合に、
　　浮いたロングエントリをショート名エントリとペアのエントリとして扱っ
　　てしまう場合がありました。
　　　これを修正しました。
　　　なお、ロング名を指定した検索では、一致したロングエントリの次のシ
　　ョートエントリとのチェックサムチェックを行っているので、不正エント
　　リとペアになることは、チェックサムが一致するケースを除いてありませ
　　ん。

（７）E5で始まる漢字名ファイルを作成できるが、ファイルにアクセスできない
　　（GRFILE_0033）
　　　1バイト目が0xE5で始まる漢字名ファイルを、GR-FILEで作成した場合、
　　作成直後でオープンしている間は、問題なく書き込みが出来ますが、一旦
　　クローズすると、以降アクセスできなくなります。
　　　これを修正しました。
　　　なお、PC等で作成した1バイト目が0xE5で始まる漢字名ファイルは、アク
　　セス可能です。

（８）ロング名に対応したショート名の生成方法に間違いがある（GRFILE_0034）
　　　ロング名に対応したショート名を生成する際に「~1」の様なファイル名
　　を生成しなければならない場合でも、「~1」の様な番号が付かない場合が
　　ありました。
　　　これを修正し、コンパイルスイッチ GRP_FS_FAT_TRY_NO_NUM_SHORT を
　　追加しました。 GRP_FS_FAT_TRY_NO_NUM_SHORT を指定するとV1.21までの
　　生成方法を使用します。

（９）メモリ不足で間違ったファイルをアクセスしてしまう可能性がある
　　（GRFILE_0035）
　　　ロング名を持つファイルのファイル名キャッシュを登録する際、メモリ
　　不足等でロング名のみが登録され、ショート名のファイル名キャッシュが
　　登録されなかった場合に、ショート名でファイルをアクセスすると、ロン
　　グ名のファイルキャッシュが残ったままとなり、以降、キャッシュに一致
　　するファイル名を指定すると、間違ったファイルをアクセスしてしまう可
　　能性がありました。
　　　これを修正しました。

（10）ボリュームラベル名に指定していないドットが入っているように見える
　　（GRFILE_0036）
　　　ルートディレクトリエントリのボリュームラベルは、ショートファイル
　　名と同じ扱いで処理を行っていました。その為、ショートファイル名と同
　　様に、８＋３形式として８文字を超えると、８文字以降との間にドットを
　　挿入して、ディレクトリエントリ情報を返していました。
　　　これを修正しました。

（11）読込専用ファイルシステムに対し、grp_fs_set_attr を実行してもエラ
　　ーとならない（GRFILE_0037）
　　　読込専用ファイルシステムに対し、grp_fs_set_attr を実行した場合、
　　エラーとならず正常終了していました。
　　　これを修正しました。
　　　なお、上記問題で正常終了してもメディアには、書き戻しは発生せず、
　　メディア内のファイル属性は変更されません。

（12）メディアが抜かれた状態でも、grp_fs_truncate で直ぐにエラーになら
　　ない（GRFILE_0038）
　　　メディアが抜かれた状態で、grp_fs_invalidate_fs_dev を実行されて
　　いても、grp_fs_truncate を実行しても直ぐにはエラーにならない場合が
　　ありました。
　　　これを修正しました。

（13）NULLポインタが設定されているI/Oバッファを参照しアクセス例外となる
　　可能性がある箇所がある（GRFILE_0039）
　　　I/Oバッファの参照終了時に、I/Oバッファのポインタ情報をNULLにした
　　まま、バッファ解放の為にgrp_fs_unblock_buf_mod関数をコールしている。
　　　これを修正しました。
　　　なお、本処理は例外保護処理であり、上記コードを実行する条件は存在
　　しません。

（14）漢字ボリュームラベルを指定するとフォーマットできない場合がある
　　（GRFILE_0040）
　　　漢字のボリュームラベルを指定してフォーマットしようとした場合、
　　GRP_FS_ERR_BAD_PARAMエラーでフォーマットできない場合がありました。
　　　これを修正しました。

（15）SDカードのセキュアエリアのフォーマットパラメータが正しくない
　　（GRFILE_0041）
　　　SDカードのセキュアエリアを grp_fat_format_sd を使ってフォーマット
　　すると、通常エリアのパラメータでフォーマットしてしまう。
　　　これを修正しました。

（16）grp_fat_format_sdで間違ったデバイス番号を指定すると不正な戻り値が
　　返ってくる（GRFILE_0042）
　　　grp_fat_format_sdを使ったSDカードのフォーマットで間違ったデバイス
　　番号を指定した場合、デバイスオープン処理のエラー番号を返す必要があり
　　ますが、デバイス番号を返していました。
　　　これを修正しました。

（17）2GB丁度のサイズ情報を返すメディアの場合、grp_fat_format_sdで
　　フォーマットできない可能性がある（GRFILE_0043）
　　　2GB丁度のメディアサイズ情報を返すメディアの場合、grp_fat_format
　　_sdでは、サイズオーバでGRP_FS_ERR_BAD_DEVエラーとしていました。
　　　これを修正しました。

（18）grp_fat_format_sd によるフォーマットでは未使用セクター情報が返ら
　　ない（GRFILE_0044）
　　　grp_fat_format_sd を使用してフォーマットを行なった場合、実際には
　　未使用セクターがあるのに、未使用セクター情報が０で返る。
　　　これを修正しました。

（19）grp_fat_find_typeで計算したFATセクター数が最適値より1大きい場合が
　　ある（GRFILE_0045）
　　　grp_fat_find_typeでセクターのバウンダリ調整が発生した場合、クラスタ
　　数を減らしてバウンダリ調整を行いますが、クラスタ数を減らした結果、
　　より少ないFATセクター数でも足りる状態となっていても、再計算せず、前の
　　値のままで返していました。
　　　これを修正しました。

（20）FAT12/16/32の境となるサイズのメディアをフォーマットすると未使用と
　　なるセクターが多い（GRFILE_0046）
　　　FAT12/16/32の境となるサイズのメディアの場合、他システムで間違って
　　別のFATタイプとして解釈される事を回避する為に、GR-FILEでは境となる
　　クラスタ数の±16クラスターの範囲は、１つ下のタイプとしてフォーマット
　　しています。その為、未使用セクターが多くなっていました。
　　　クラスタ範囲を±10クラスタにすることで未使用セクタを減らしました。

（21）grp_mem_vl_pool.hで、自ファイルをincludeしている（GRFILE_0047）
　　　grp_mem_vl_pool.hで、自ファイルをincludeしていました。
　　　但し、コンパイル制御文により対策を行っている為、多重includeしても
　　問題ありません。
　　　自ファイルのincludeを削除しました。

（22）マウントで指定したオプションで、grp_fs_get_mnt などで返らない物が
　　ある（GRFILE_0048）
　　　マウントで指定した GRP_FS_NO_UPD_ACCTIME、GRP_FS_NO_MNT_FLAG、GRP_
　　FS_NO_CRT_ACCTIME に対応した情報が、grp_fs_get_mnt等で返されませんで
　　した。
　　　これを修正しました。

（23）システムによって、grp_fs_check_volumeでボリュームラベル情報を正しく
　　取得できない場合がある（GRFILE_0049）
　　　CPUのデータキャッシュをONで使用しているシステムにおいて、grp_fs_
　　check_volumeで取得したボリュームラベル情報が、CPUのデータキャッシュ
　　にキャッシングされていた情報で置き換わり、正しく取得できない場合が
　　ありました。
　　　これは、物理セクタ長が512バイト以下の場合のI/Oバッファをスタック
　　に確保していた為です。物理セクタ長に依存せず、動的にI/Oバッファを
　　確保するように修正しました。

（24）ディレクトリの作成で内部情報領域の割り当てに失敗した場合、作成に
　　失敗した情報が残ったままとなる（GRFILE_0050）
　　　ディレクトリの作成で内部情報領域の割り当てに失敗した場合、作成に
　　失敗したディレクトリエントリがメモリ/メディア上に残ったままとなり、
　　本来解放されているはずのクラスタが再利用されて、クラスタの2重割り当て
　　などが発生する可能性がありました。
　　　これを修正しました。
　　　なお、内部情報領域の割り当てに失敗する現象は、GR-FILEのパラメータ
　　設定不良などがなければありません。

（25）リネームでディレクトリエントリの書込みに失敗した場合、内部クローズ
　　処理が余分に実行される（GRFILE_0051）
　　　grp_fs_rename などで、ディレクトリエントリの書込みに失敗した場合、
　　内部的にクローズ処理が余分に実行され、GR-FILEの内部エラー表示が出力
　　される場合がありました。
　　　これを修正しました。

（26）ディレクトリの拡張に失敗した場合、解放すべきクラスタが割り当てた
　　ままの状態となる（GRFILE_0052）
　　　I/Oエラーなどで拡張したディレクトリクラスタのクリアに失敗した場合、
　　割り当てたクラスタが正しくクリアされていないにもかかわらず、割り当て
　　たままの状態となる場合がありました。その結果、初期化されていないクラ
　　スタをディレクトリ情報として解釈してしまい、ファイルシステムとして
　　不整合な状態となる場合がありました。
　　　これを修正しました。

（27）ディレクトリのリネームを失敗した場合にファイルシステムが壊れる可能性
　　がある（GRFILE_0053）
　　　ディレクトリを別のディレクトリへリネームした場合で、リネームが失敗
　　した場合、以降のリネームに失敗したディレクトリへの操作でファイルシス
　　テムが壊れる可能性がありました。
　　　リネームの際に親ディレクトリ情報の更新に失敗しても、GR-FILE内部の
　　親ディレクトリ情報を元に戻していない為、間違ったアクセスをする可能性
　　がありました。
　　　これを修正しました。

（28）ディレクトリエントリの書き込みに失敗した場合、ディレクトリエントリが
　　なくなる場合がある（GRFILE_0054）
　　　ディレクトリエントリを書き込む際に、バッファやクラスタを跨ぐ必要が
　　発生し、エントリの後ろ部分の書き込みに失敗した場合に、書き込んだエン
　　トリの前部分の削除を行う必要があります。この削除処理でエントリ領域を
　　0xE5ではなく、０でクリアしてしまっている為、以降のエントリが無い物と
　　して扱われてしまいます。
　　　これを修正しました。

（29）メディアを取り外した状態で更新処理を実行し、エラーとなった状況で、
　　メディアを再挿入してもファイルシステムとして不整合な状態となる
　　（GRFILE_0055）
　　　メディアを取り外した状態で、書込みを実行し、ファイルを拡張しようと
　　したり、クラスタ割り当てを失敗して、書込みがエラー終了となった場合、
　　その状態でメディアを再挿入し、メモリ上に残っているキャッシュ情報を
　　書き戻すと、書込みに失敗したはずのファイルが空きクラスタをファイルの
　　クラスタとして認識したり、どのファイルからも認識されない空クラスタで
　　ないクラスタができる場合がありました。
　　　これを修正しました。

（30）grp_mem_vl_add/grp_mem_vl_add_poolに対し、負のサイズを指定すると
　　アクセス例外を起す（GRFILE_0057）
　　　grp_mem_vl_add/grp_mem_vl_add_poolに対し、iPoolSizeパラメータとして、
　　負の値を指定すると、符号なしの値として解釈し、大きな領域をクリアしよう
　　として、アクセス例外を起す可能性がありました。
　　　これを修正しました。

（31）複数タスクでファイルをクリエイトした際にGRP_FS_ERR_TOO_MANYエラーに
　　なる事がある（GRFILE_0062）
　　　GR-FILEのパラメータを正しく設定していても、複数のタスクでファイルを
　　作成すると、リソース不足が発生し、GRP_FS_ERR_TOO_MANYエラーが発生する
　　ことがありました。
　　　タスクAとタスクBが有る場合に、タスクAがファイル/ディレクトリを作成し、
　　IO中に、タスクBがファイル/ディレクトリを作成した場合に、内部リソースの
　　状態によってはリソース不足が発生し、GRP_FS_ERR_TOO_MANYエラーとなります。
　　　これを修正しました。
　　　なお、本現象はシングルタスクでは発生しません。
　　　また、エラーと認識している為、それ以上の異常動作もありません。

（32）grp_fs_err関数で返されるGRP_FS_ERR_SEMに対するエラーメッセージの
　　スペルが正しくない（GRFILE_0056）
　　　grp_fs_err関数で返されるGRP_FS_ERR_SEMに対するエラーメッセージの
　　errorのスペルが間違っていました。
　　　これを修正しました。
　　　なお、本修正はVersion1.21で修正済みです。

（33）grp_fs_proc_event.cにGRP_FS_MINIMIZE_LEVELを追加
　　　grp_fs_proc_event.cはGRP_FS_MINIMIZE_LEVELオプションによる削除
　　対象でしたが、対応できていませんでした。
　　　これを修正し、GRP_FS_MINIMIZE_LEVELの設定で削除するようにしました。

　　なお、以上の修正で、Version1.21に対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.21と同じです。
　
　　・src/grp_fs/base/
　　　　fat.c
　　　　fat.h
　　　　fat_format_def.h
　　　　grp_fat_format.c
　　　　grp_fs.c
　　　　grp_fs_get_cwd_lib.c
　　　　grp_fs_trace.c
　　・src/grp_fs/include/
　　　　grp_fat_format.h
　　　　grp_fs_if.h
　　　　grp_fs_sysdef.h
　　・src/grp_fs/lib/grp_mem/
　　　　grp_mem_vl_pool.c
　　　　grp_mem_vl_pool.h
　　・src/grp_fs/lib/grp_stdio/
　　　　grp_stdio_fprintf.c
　　　　grp_stdio_vfprintf.c
　　・src/mdep_vos/lib/grp_sem/
　　　　grp_sem.c
　　・src/sample/base/
　　　　grp_fat_format_sd.c(※1)
　　　　
　　(※1)ご要望のある場合のみご提供しています。

１.９　本リリースVersion 1.21 での変更内容

　Version 1.20に対し、以下の機能を追加しました。

（１）使用ROM量の削減レベルを設定するオプションを追加
　　　GR-FILEで使用するROM量の削減レベルを設定するオプション
　　GRP_FS_MINIMIZE_LEVELを追加しました。
　　　このオプションを使用することで削減レベルを2段階に調整することが
　　できます。
　　　レベル1：POSIX互換、C言語標準I/OのAPI、GR-FILEの特殊なAPIを除外します。
　　　レベル2：レベル1に加えて、LFN(ロングファイル名)のサポートを除外します。

　　なお、以上の修正で、Version1.20に対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.20と同じです。
　
　　・src/grp_fs/base/
　　　　fat.c
　　　　grp_fs.c
　　　　grp_fs_conv_lib.c
　　　　grp_fs_error.c
　　　　grp_fs_get_cwd_lib.c
　　　　grp_fs_io_disk_part.c
　　　　grp_fs_readdir.c
　　　　grp_fs_mdep_if.h
　　・src/grp_fs/include/
　　　　grp_char_conv.h
　　　　grp_fs_conv.h
　　　　grp_fs_disk_part.h
　　　　grp_fs_if.h
　　　　grp_fs_readdir.h
　　　　grp_fs_sysdef.h
　　　　grp_stdio.h
　　・src/grp_fs/lib/grp_char/
　　　　grp_char_sjis_conv.c
　　・src/grp_fs/lib/grp_stdio/
　　　　grp_stdio_default_io.c
　　　　grp_stdio_fclose.c
　　　　grp_stdio_fflush.c
　　　　grp_stdio_fill.c
　　　　grp_stdio_fopen.c
　　　　grp_stdio_fprintf.c
　　　　grp_stdio_fread.c
　　　　grp_stdio_fseek.c
　　　　grp_stdio_ftell.c
　　　　grp_stdio_fwrite.c
　　　　grp_stdio_getc.c
　　　　grp_stdio_gets.c
　　　　grp_stdio_putc.c
　　　　grp_stdio_vfprintf.c
　　・src/mdep_itron/base/
　　　　grp_fs_mdep_if.c
　　・src/mdep_vos/base/
　　　　grp_fs_mdep_if.c
　　・src/sample/base/
　　　　grp_fat_format_sd.c(※1)
　　　　
　　(※1)ご要望のある場合のみご提供しています。

１.１０　Version 1.20 での変更内容

　Version 1.11hに対し、以下の機能強化、改善を行いました。

（１）多国語オプションへ対応
　　　GR-FILEの機能拡張オプションである、多国語オプションへ対応しまし
　　た。
　　　これまでも多国語オプションは、ポーティングに多くの作業が必要な為、
　　カスタマイズにてお受けしておりましたが、Version 1.20よりコンパイル
　　スイッチを指定することで、GR-FILEから多国語オプションのソースファイ
　　ルを、インクルード出来るようになりました。
　　　これにより多国語オプションのポーティングをお客様にて行うことが出
　　来るようになります。
　　　多国語オプションには以下の機能があります。
　　　　・同時多国語ファイル名対応機能
　　　　・単一ディレクトリ内の高速ファイル検索機能

（２）ディレクトリ構成の変更
　　　Version1.20では、使い易さの向上、ポーティング作業の明確化の為に、
　　ディレクトリ構成を変更しました。
　　　GR-FILEのベースとなる部分と、環境に依存する部分に分けられました。
　　　その為、ディレクトリが細分化されています。
　　　既にGR-FILEをお使いのお客様には、旧ディレクトリ構成へ移行する為の
　　説明書「GR-FILE旧構成への移行手順.pdf」を参照頂く事で、Version1.20
　　以前のディレクトリ構成にすることが出来ます。

（３）改行コードの変更
　　　Version1.20より、改行コードを他のGR製品と統一しました。
　　　これにより改行コードは CRLF となります。
　　　1.11hまでの改行コードは LF のみでしたが、他のGR製品と統一する為に
　　全ファイルの改行コードを CRLF としました。
　　　過去のソースファイルと比較する際は、改行コードを無視してください。

（４）リードオンリーマウント時のフリークラスタ検索の簡易化
　　　GR-FILEは、マウント時に空きクラスタ数を算出する為に、FATのフリー
　　クラスタを検索します。
　　　その為、メディアの状態によっては、FATの全領域を読み込む事になり、
　　時間が掛かっていました。
　　　特にFAT32では、FATのサイズが大きくなる為、マウントに要する時間が
　　長くなっていました。
　　
　　　そこで、リードオンリーマウント時に下記条件に当たる場合は、FSINFOの
　　フリークラスタ数情報を用いる事とし、フリークラスタの検索を行わない様
　　に改善しています。
　　　　・FAT32ファイルシステム
　　　　・マウント方法が、リードオンリー
　　　　・FSINFOに含まれる、Free cluster count、および、Next free cluster
　　　　　情報が使用可能

（５）リードオンリーマウント時の強制マウントフラグ以外のフラグクリア
　　　GR-FILEでは、マウント時にキャッシュの反映方法などのマウントモード
　　を指定できます。
　　　マウントモードに、リードオンリーを指定した場合は、一切の書き込みが
　　出来なくなりますので、書き込みに関する設定は必要なくなります。
　　　ですが、マウントモードで指定された機能は、内部的に呼び出され、資源
　　を使用していました。
　　　マウント時にリードオンリーが指定されていた場合には、強制マウント
　　以外のマウントモードをクリアすることで、不要な処理を行わなくする様に
　　改善しました。

（６）ボリュームラベルのNULL終端処理
　　　GR-FILEでは、メディアをフォーマットする際のパラメータとして、
　　ボリュームラベルを指定出来ます。
　　　ボリュームラベルの指定方法として、11バイトの文字列を指定する事が
　　出来ますが、従来まではNULL終端が出来ませんでした。
　　　更に、11バイトに満たない場合は、スペースで埋める必要がありました。
　　　そこで、11バイト中にNULL文字('\0')を見つけた場合は、以降の領域に
　　スペースを埋める処理を追加しました。
　　　ただし、ボリュームラベルの領域は、11バイトのままですので、11文字の
　　ボリュームラベルを指定する際は、NULL終端が出来ない事に注意下さい。

（７）FAT32のFATの上位4ビットを無視
　　　FAT32の仕様では、FATの上位4ビットは予約領域として無視する必要が
　　ありました。
　　　また、上位4ビットは元の状態を維持する必要がありました。
　　　これまでは、FATの上位4ビットも含め、FATとして扱っていた為、上位
　　4ビットがセットされていた場合にエラーとなっていました。
　　　そこで、FATの読み込み時に上位4ビットをマスクし、書き込み時は元の
　　上位4ビットとマージをするように処理を追加しました。
　　　また、フリークラスタの検索時も、FATの上位4ビットを無視するように
　　変更しました。
　　　以前までのGR-FILEでは、上位4ビットを使用するような例が確認できて
　　いなかったことと、FAT値を操作する事による動作不良の可能性を排除する
　　ため、本仕様は実装されていませんでした。
　　　ですが、実際に上位4ビットがセットされている例が確認出来たため、
　　本仕様を実装しました。

　Vesrion 1.11hに対し、以下のバグ修正を行いました。

（１）フリークラスタ検索時の物理セクタ長≠論理セクタ長による不具合
　　　GR-FILEは、マウント時にフリークラスタのキャッシュリストを作成する
　　ために、FATを読み込みます。
　　　その際に、メディアの物理セクタ長とBPBに書かれている論理セクタ長が
　　異なる場合に、正しいデータへアクセスできませんでした。
　　　これを修正しています。

（２）親クラスタがクラスタループ時の無限ループバグ
　　　GR-FILEは、サブディレクトリ内より、親ディレクトリを参照する際に、
　　ディレクトリエントリ中の「..」エントリを参照し、親ディレクトリの
　　クラスタ番号を取得します。
　　　その後、親ディレクトリより、自分のディレクトリエントリを検索します。
　　　この時、親ディレクトリがクラスタループを構成していた場合に、自分の
　　エントリを見つけられない場合は、無限ループを起こしていました。
　　　これを修正しています。
　　　本現象は、「..」エントリに記録されている、親ディレクトリがクラスタ
　　ループを形成し、さらにキャッシュ上に無い場合に発生しますが、通常は
　　親ディレクトリよりサブディレクトリへ移動する過程で、キャッシュに読み
　　込まれるため発生しません。
　　　上記の様な、メディア上のデータが非常に特殊な壊れ方をしていた場合に
　　発生する問題です。

（３）同一メディアチェックでセクタ長が異なるデバイスの挿抜による不具合
　　　誤挿抜時のデバイス同一チェックにおいて、先に挿入されていた
　　デバイスの物理セクタ長より大きなデバイスを挿入すると、リードバッファ
　　以上のデータを読み込み、メモリ破壊を起こしていました。
　　　これは、誤挿抜時は先に挿入されていたデバイスのセクタ長を保持して
　　おり、このセクタ長を使用してバッファを確保していました。
　　　その為、後から挿入されたデバイスのセクタ長が大きい場合、バッファ
　　サイズ以上のデータを読み込み、メモリ破壊を起こしていました。
　　　これを修正しています。

　　なお、以上の修正で、Version1.11hに対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.11hと同じです。
　　変更ファイルの多くは、改善点「（２）ディレクトリ構成の変更」の変更
　による物です。
　　また、改善点「（３）改行コードの変更」による変更ファイルは含まれま
　せん。
　
　　・src/grp_fs/base/
　　　　fat.c
　　　　grp_fat_format.c
　　　　grp_fs.c
　　　　grp_fs_cfg.c
　　　　grp_fs_conv_lib.c
　　　　grp_fs_dev_io_if.c
　　　　grp_fs_error.c
　　　　grp_fs_get_cwd_lib.c
　　　　grp_fs_get_disk_part.c
　　　　grp_fs_io_disk_part.c
　　　　grp_fs_readdir.c
　　　　grp_fs_set_disk_part.c
　　　　grp_fs_trace.c
　　　　fat.h
　　　　grp_fs.h
　　　　grp_fs_mdep_if.h
　　・src/grp_fs/include/
　　　　grp_fat_param.h
　　　　grp_fs_cfg.h
　　　　grp_fs_conv.h
　　　　grp_fs_if.h
　　　　grp_fs_param.h
　　　　grp_fs_readdir.h
　　　　grp_fs_sysdef.h
　　　　grp_sem.h
　　　　grp_stdio.h
　　・src/grp_fs/lib/grp_char/
　　　　grp_char_sjis_conv.c
　　・src/grp_fs/lib/grp_mem/
　　　　grp_mem_vl_pool.c
　　　　grp_mem_vl_pool.h
　　・src/grp_fs/lib/grp_stdio/
　　　　grp_stdio_default_io.c
　　　　grp_stdio_fclose.c
　　　　grp_stdio_fflush.c
　　　　grp_stdio_fill.c
　　　　grp_stdio_fopen.c
　　　　grp_stdio_fprintf.c
　　　　grp_stdio_fread.c
　　　　grp_stdio_fseek.c
　　　　grp_stdio_ftell.c
　　　　grp_stdio_fwrite.c
　　　　grp_stdio_getc.c
　　　　grp_stdio_gets.c
　　　　grp_stdio_putc.c
　　　　grp_stdio_vfprintf.c
　　・src/grp_fs/lib/grp_time_lib/
　　　　grp_time_lib.c
　　・src/mdep_itron/base/
　　　　grp_fs_dev_io.c
　　　　grp_fs_dev_sw_tbl.c
　　　　grp_fs_mdep_if.c
　　　　grp_fs_mdep_types.h
　　・src/mdep_itron/include/
　　　　grp_fs_mdep_types.h
　　　　grp_mdep_sem.h
　　・src/mdep_itron/lib/grp_mem/
　　　　grp_mem.c
　　・src/mdep_itron/lib/grp_sem/
　　　　grp_sem.c
　　・src/mdep_itron/lib/grp_time/
　　　　grp_time_get.c
　　　　grp_time_set.c
　　・src/mdep_vos/base/
　　　　grp_fs_dev_io.c
　　　　grp_fs_dev_sw_tbl.c
　　　　grp_fs_mdep_if.c
　　・src/mdep_vos/include/
　　　　grp_fs_mdep_types.h
　　　　grp_mdep_sem.h
　　・src/mdep_vos/lib/grp_mem/
　　　　grp_mem.c
　　・src/mdep_vos/lib/grp_sem/
　　　　grp_sem.c
　　・src/mdep_vos/lib/grp_time/
　　　　grp_time_get.c
　　　　grp_time_set.c
　　・src/sample/base/
　　　　grp_fat_format_sd.c(※1)
　　　　grp_fs_dev_io_ram.c
　　　　grp_fs_proc_event.c
　　　　
　　(※1)ご要望のある場合のみご提供しています。

１.１１　Version 1.11h での変更内容

　Vesrion 1.11gに対し、以下のバグ修正を行いました。

（１）GR-VOS依存処理のgrp_fs_create_sem関数のセマフォア名の修正
　　　GR-VOS依存処理のgrp_fs_create_sem関数において、セマフォアを作成する際、
　　iInstance引数を使用して作成したセマフォア名を使用せず、pcNameだけを使って
　　セマフォアを作成していました。
　　　そこで、iInstance引数を使用して作成したセマフォア名を使用するように修正
　　しました。

（２）ルートなどのディレクトリのFAT異常による無限セマフォア待ち問題の修正
　　　親ディレクトリにFAT異常があり、フリークラスタに割り当てられていた場合、
　　ファイルの書き込みを行うと、親ディレクトリクラスタと、ファイルのクラスタが
　　同じクラスタに割り当てられ、お互いにセマフォアの解放待ちとなって、デッド
　　ロックが発生する場合がありました。
　　　そこで、ファイルの書き込みを行う際に、親ディレクトリのクラスタと、ファ
　　イルのクラスタが同じ場合は、GRP_FS_ERR_FSを返すように修正しました。
　　　また、マウント時にFORCEオプションが指定されていなければ、ルートディレクト
　　リクラスタのFAT情報をチェックし、異常を検出した場合はGRP_FS_ERR_FSを返し、
　　マウントを行わない様にしました。
　　　さらに、ファイル/ディレクトリのオープン/検索時に、当該ファイル/ディレクト
　　リの先頭クラスタのFAT情報をチェックし、同FAT情報が不正な場合、GRP_FS_ERR_FS
　　を返すようにしました。
　　　なお、上記オープン/検索時のFAT情報のチェックは、グローバル変数 fat_check_
　　cluster_at_open で制御可能です。グローバル変数 fat_check_cluster_at_open を
　　 0 に設定すると、従来と同じ動作を行います。
　　　グローバル変数 fat_check_cluster_at_open は、デフォルトで 1 に設定されて
　　います。

（３）クラスターループによる無限ループ問題の修正
　　　ファイルシステム異常で、クラスタループがあった場合、grp_fs_get_dirent/
　　grp_fs_get_attr時のディレクトリサイズ計算や、grp_fs_openなどで行なわれる
　　ディレクトリ内のファイル検索の際、GR-FILE内でクラスタリンクを辿り、無限
　　にループしてしまうという問題がありました。
　　　そこで、上記問題に対し、各FATタイプで許容された最大サイズのディレクトリ
　　内オフセットで、ループから抜ける処理を追加しました。
　　　さらに、上記対策でもFATで許容されるサイズが大きく、実質的に長時間I/Oが
　　繰り返され、無限ループと近い状況となるため、アプリケーション側の判断で中断
　　できるインタフェース（フック関数）を追加しました。
　　　追加されたインタフェースの詳細については、GR-FILEのマニュアルの4.10節を
　　ご参照下さい。

（４）長いエントリ名によるgrp_fs_get_cwd関数での暴走問題の修正
　　　カレントディレクトリを、長いエントリ名のディレクトリに設定し、カレント
　　ディレクトリのフルパス名を取得した場合に、grp_fs_get_cwd関数で、バッファを
　　オーバし、スタックを破壊する場合がありました。
　　　そこで、長いエントリ名でも、スタックを破壊しないように修正しました。

（５）grp_time_localtimeのバグによる曜日計算不正、閏年の2月の日付情報異常の修正
　　　閏年の2月にファイルの作成、更新、アクセスを行うと、日付計算に失敗し、
　　-1日した日付や異常な日付情報を書き込んでしまう問題がありました。
　　　また、grp_time_localtimeでの曜日計算時、型キャスト位置が正しくない為、
　　曜日を正常に算出できていませんでした。
　　　そこで、日付情報と曜日を正しく計算できるように修正しました。

（６）マウント時のBPBのFSバージョン確認処理の追加
　　　ファイルシステムのマウント時に、BPB（Boot Parameter Block）に記録されている
　　FS（FileSystem）バージョン情報をチェックする処理を追加しました。
　　　これにより、FSのバージョンが0:0以外のFATメディアは、GRP_FS_ERR_FSエラーを
　　返し、マウントできないようにしました。

（７）ファイル作成時刻情報の精度落ち問題の修正
　　　FATメディア上の作成時刻情報のうち、10msec単位の時刻情報の解釈/設定が
　　間違っていたため、2秒未満の情報が正しく解釈/設定できず、2秒単位の精度に
　　なっていた問題を修正しました。

（８）クラスタループファイルへの書き込みでエラーにならない問題の修正
　　　ファイルのデータ部分がクラスタループになっている場合、ファイルの上書きや
　　追記時に、新しいクラスタを割り当てられず、ファイルの書き込みが出来無いが、
　　エラーを返さず正常終了を返す問題を修正しました。

　　なお、以上の修正で、Version1.11gに対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.11gと同じです。

　　・grp_file/fat.c
　　・grp_file/fat.h
　　・grp_file/grp_fs.c
　　・grp_file/grp_fs_get_cwd_lib.c
　　・grp_file/grp_fs_mdep_if_vos.c
　　　(= grp_file/grp_fs_mdep_if.c)
　　・grp_time_lib/grp_time_lib.c

１.１２　Version 1.11g での変更内容

　Vesrion 1.11fに対し、以下のバグ修正を行いました。

（１）FATのクラスタの解放処理のロック漏れ修正
　　　FATのクラスタの解放処理にロック漏れがあり、複数タスクで同時に
　　ファイルの削除、生成/書込みを頻繁に行なうと、メモリ上の空クラスタ
　　テーブル領域をオーバして、空クラスタ情報の登録を行なう場合があるの
　　を修正しました。

（２）FAT32フォーマットのルートディレクトリの最終クラスタ情報、及び、
　　　FAT0情報の間違い修正
　　　GR-FILEのフォーマット機能を使って、FAT32でフォーマットした場合、
　　ルートディレクトリの最終クラスタの次クラスタ情報が、0x0fffffffではなく、
　　0xffffffffとなっていたのを修正しました。
　　　同様に、FAT0情報が0x0fffffXXのところ、0xffffffXXとなっていたのを
　　修正しました。

 (３）壊れたディレクトリ情報によるデッドロック問題の修正
　　　壊れたメディアに対して、grp_fs_get_direntを実行すると、ディレクトリ
　　情報の壊れ方によっては、デッドロックに陥る問題を修正しました

（４）アクセス中の強制アンマウントによる動作不良の可能性の修正
　　　あるタスクでファイルをアクセス中に、別タスクで強制アンマウントを
　　実行すると、タイミングによっては、アクセス例外などを起す可能性が
　　あるのを修正しました。また、grp_fs_syncでの、マウント/アンマウント処理
　　の不要なwakeup処理を削除しました。

（５）フォーマット時のボリュームラベル名チェック処理誤りの修正
　　　フォーマット処理のボリュームラベル名の文字チェックに誤りがあり、
　　ショートファイル名で使用不可な文字を含むボリュームラベル名を指定しても、
　　フォーマット要求がエラーとならない問題を修正しました。

（６）プラットフォーム依存コードgrp_mem_allocのITRON版の修正
　　　grp_mem_allocのITRON版サンプルコードを、万一メモリ不足の場合に、
　　無限待ちにならないように、get_mplから pget_mplに変更しました。

（７）16ビットCPUサポートのための修正
　　　16ビットCPUサポートのため、タイプのキャスト処理や一部タイプの変更を
　　全体的に行いました。

  なお、以上の修正で、Version1.11fに対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.11fと同じです。

　　・grp_char/grp_char_sjis_conv.c
　　・grp_file/fat.c
　　・grp_file/grp_fat_format.c
　　・grp_file/grp_fs.c
　　・grp_file/grp_fs.h
　　・grp_file/grp_fs_dev_io_if.c
　　・grp_file/grp_fs_get_cwd_lib.c
　　・grp_file/grp_fs_io_disk_part.c
    ・grp_include/grp_types.h
    ・grp_mdep/grp_mem.c
　　・grp_mem/grp_mem_vl_pool.c
　　・grp_stdio/grp_stdio_fflush.c
　　・grp_stdio/grp_stdio_fill.c
　　・grp_stdio/grp_stdio_fread.c
　　・grp_stdio/grp_stdio_fseek.c
　　・grp_stdio/grp_stdio_ftell.c
　　・grp_stdio/grp_stdio_fwrite.c
　　・grp_stdio/grp_stdio_getc.c
　　・grp_stdio/grp_stdio_putc.c
　　・grp_time_lib/grp_time_lib.c

１.１３　Version 1.11f での変更内容

　Vesrion 1.11eに対し、以下のバグ修正、機能追加変更を行いました。

（１）ファイル名キャッシュ利用時の ".." 移行後のディレクトリ削除
　　　によるファイル管理情報書き込み間違い問題の修正
　　　以下のすべての条件を満たす条件下でディレクトリを削除した場合、
　　メディアの正しい場所に管理情報が書き込まれず、当該ディレクトリが
　　削除されないで、当該ディレクトリの情報がファイルシステムとして
　　不正な状態となる場合があるという問題を修正しました。

　　（ａ）ファイル名キャッシュを使用している
　　（ｂ）削除対象のディレクトリよりさらに内側にカレントディレ
　　　　　クトリを設定し、以降、多数のファイルをopen/close
          したため、削除対象のディレクトリのオープンファイル
　　　　　キャッシュがキャッシュから追い出されてしまっている
　　（ｃ）".."を使用し、削除対象のディレクトリまで戻り、
　　　　　同ディレクトリ下のファイル/ディレクトリをすべて
　　　　　削除した
　　（ｄ）さらに、".."で、削除対象のディレクトリの外に出て、
　　　　　同ディレクトリを削除した

（２）階層化マウントされたメディア跨りのパス指定でのO_TRUNC
　　　オプション指定によるunmount不可問題の修正
　　　階層化マウントされた複数のメディアに跨るパスを指定して、
　　O_TRUNC（またはGRP_FS_O_TRUNC)モードでオープン処理を
　　実行した場合、ファイルシステムの参照カウントが正しく
　　更新されず、メディアをunmountできなくなる問題を修正しました。

（３）メディア取り出し等のI/Oエラーによるキャッシュバッファ
　　　枯渇時のデッドロック問題の修正
　　　unmountなしでのメディアの取り出しなどで発生したI/O
　　エラーにより、データを書き戻せず、キャッシュバッファが
　　枯渇した場合、通常は、GRP_FS_ERR_NOMEMが返るところ、
　　ある特殊なケースで、キャッシュバッファを2面確保しようとして、
　　デッドロックとなる場合があるという問題を修正しました。

（４）メディア挿抜処理のサンプルコードgrp_fs_proc_event.c
    の関数パラメータの渡し漏れの修正
　　　メディア挿抜処理のサンプルコードgrp_fs_proc_event.c
　　の_grp_fs_exec_unmount関数において、_grp_fs_get_response
    関数へのパラメータが不足していた問題を修正しました。

（５）メディア挿抜処理のサンプルコードgrp_fs_proc_event.c
    のエラーデータの読み出し処理のifdefオプション化
　　　メディア挿抜処理のサンプルコードgrp_fs_proc_event.c
　　の_grp_fs_proc_bad_media関数において、書き戻し不能となった
　　エラーデータの読み出し処理がポーティング対象という形で
　　入っていましたが、実装されずに放置されるケースが多く、
　　また、サンプルでは、RP_FS_SAVE_BUF_SIZE分の大きな領域を
　　スタック上に取っているため、スタック不足で、動作が不良を
　　起すケースも多いため、GRP_FS_SAVE_ERROR_DATAという
　　ifdefオプションに変更しました。

（６）grp_mdep/grp_sem.cのgrp_sem_releaseのifdefオプション
    名称の間違いの修正
　　　grp_mdep/grp_sem.cのgrp_sem_release関数のGRP_VOS用の
　　実装がT_KERNELというifdefオプションの中に入っていたのを
　　GRP_VOSに修正しました。

（７）FAT32の空きクラスタ数のヒント情報のunmount時以外の書き戻し
　　　これまでunmount時にしか書き戻さなかったFAT32の空きクラスタ数
　　のヒント情報を、mount時に指定したキャッシュの書き戻しタイミングや
　　明示的なgrp_fs_syncコール時にも行なうようにし、不意のメディア
　　の取り出し時にも、ヒント情報をできる限り正しく保てるように
　　しました。

（８）GRP_FS_SYNC_ALL時のキャッシュ書き戻しの厳密化
　　　これまでGRP_FS_SYNC_ALL指定時でもファイルの属性情報の変更を
　　ファイルclose時に行なっていたところを、更新毎に毎回行なう
　　ように変更しました。また、内部処理で、SYNC_ALL指定と、一時的な
　　SYNC指定の両方が設定されていた場合、書き戻し処理が実行されない
　　という問題を修正しました。

（９）「\」「/」で始まるパスのメディアルートとしての扱い
　　　これまで、ファイルの絶対パス指定は、mount時に指定したマウント
　　ポイント名と同じ文字列で始まらないと、それぞれのメディアのルート
　　として扱いませんでしたが、「\」「/」で始まるパスでファイル名を指定
　　した場合、以下の順でマッチしたメディアのルートとして扱うように
　　変更しました。

　　　①マウントポイントが「\」または「/」のメディア
　　　②要求したタスクのカレントディレクトリのメディア
　　　③最初にマウントしたデフォルトメディア

　　(例１）「/」にメディア１、「B:」にメディア2をマウントし、
　　　　　　カレントディレクトリがメディア2内の「DIR」である
　　　　　　状態で「\」を指定した場合

　　　　　　【従来】　メディア2内の「DIR」を参照
　　　　　　【新仕様】メディア1内のルートディレクトリを参照

　  (例２）「A:」にメディア１、「B:」にメディア2をマウントし、
　　　　　　カレントディレクトリがメディア2内の「DIR」である
　　　　　　状態で「\」を指定した場合
　　　
　　　　　　【従来】　メディア2内の「DIR」を参照
　　　　　　【新仕様】メディア2内のルートディレクトリを参照

（10) 物理セクターサイズと異なる論理セクターサイズのサポート
　　　これまで、物理セクターサイズと異なる論理セクターサイズ
　　でフォーマットされたFATファイルシステムを、ダイレクトI/O
　　でI/Oすると正しくI/Oできなかった問題を解決し、物理セクター
　　サイズと異なる論理セクターサイズのファイルシステムも完全
　　サポートとしました。

（11）デバイスドライバのエラー番号の透過リターン
　　　これまで、デバイスドライバでI/Oエラーを検出した場合、
　　デバイスドライバから返したエラー番号にかかわらず、
　　GR-FILE側でGRP_FS_ERR_IOを返していたところを、
　　デバイスドライバからのエラー番号を透過で返すように
　　しました。

（12）2GB以上のファイルのI/O制限の追加
　　　GR-FILEでは、POSIX仕様に、従い各ファイルのサイズは2GBまでと
　　なっているため、既存の2GB以上のファイルに対しては、ファイル
　　サイズを2GB-1に補正し、write処理では、2GB以上のファイルを
　　作成できないようにガードする処理を追加しました。
  
（13）rename時のファイルの実行可能属性の更新
　　　FATには、ファイルの属性として実行可能かどうかを区別する情報が
　　ないため、GR-FILEでは、ファイル名が特定のSUFFIXで終わる場合に、
　　statやgrp_fs_get_attr等で返すファイルの属性情報として、仮想的に
　　実行可能属性ありで返す仕様にしておりますが、ファイルのrename時に、
　　この仮想的な実行可能属性を更新していなかったため、rename時にも、
　　ファイル名に合わせて更新するようにしました。

（14）FATアクセス時刻情報更新時のタイムゾーンの考慮
　　　これまでグリニッジ標準時刻換算で日付が変った際にFATメディア
　　上のアクセス時刻情報更新を行なっていたところを、ローカル時刻
　　換算で日付が変った際に更新するように変更しました。

  なお、以上の修正で、Version1.11eに対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.11eと同じです。

    ・grp_file/grp_fs.c
　　・grp_file/fat.[ch]
    ・grp_file/grp_fs_cfg.h
    ・grp_file/grp_fs_proc_event.c
    ・grp_include/grp_fs_if.h
    ・grp_mdep/grp_sem.c

１.１４　Version 1.11e での変更内容

  Version 1.11d に対し、以下のバグ修正を行いました。

（１）O_CREATモード指定時の書込み権限チェック問題の修正による
　　　デグレードの解決
　　　1.11dのO_CREATモード指定時の書込み権限チェック問題の修正
　　にミスがあり、例えば、O_CREAT｜O_WRONLY指定でopenを行い、
　　ファイルが存在した場合、書き込み権限があっても権限エラーでopen
    できないなどの問題が発生するという問題を修正しました。

（２）マウント情報取得関数で返すデバイス名情報の修正
　　マウント情報の取得関数grp_fs_get_mnt, grp_fs_get_mnt_by_dev, 
　　grp_fs_get_mnt_by_nameにおいて、マウントデバイスのデバイス
　　番号の下位1バイトをサブデバイス番号と解釈し、GR-FILEの1.00
　　形式のデバイス名称を返していたところを、サブデバイス番号と
　　パーティション指定部に分割して解釈し、1.11形式のパーティション
　　名付きのデバイス名称で返すように修正しました。

（３）パーティションの有無の判定方式の変更
　　　grp_fs_get_partでのパーティションの有無判定方式を変更し、
　　iPodなどのようにパーティションがあるにもかかわらず、
　　メディアの先頭にFATの管理情報のようなものがあるために、
　　パーティションなしと判定される問題を解決しました。

（４）0バイトファイル名キャッシュのpurge漏れの修正
　　　0バイトファイル名キャッシュのpurge漏れがあり、
　　GRP_FS_FNAME_CACHEオプションを使用している場合、0バイト
　　ファイルのアクセスを繰り返しているうちに、別の0バイト
　　ファイルをアクセスしてしまうケースがあるという問題を
　　解決しました。

（５）ディレクトリ情報が壊れたメディアに対するディレクトリ
　　　削除による暴走の可能性の回避
　　　ディレクトリ情報が壊れたメディアのディレクトリを
　　削除しようとした場合、その壊れたディレクトリ情報が、
　　ある特殊な条件を同時に幾つか満足すれば、データを壊し、
　　暴走する可能性があるという問題を修正しました。

なお、以上の修正で、Version1.11dに対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.11dと同じです。

    ・grp_file/grp_fs.[ch]
　　・grp_file/fat.c
    ・grp_include/grp_fs_disk_part.h
　
１.１５　Version 1.11d での変更内容

  Version 1.11c に対し、以下のバグ修正を行いました。

（１）複数タスクアクセス時のデットロック問題の解決
　　　複数タスクでの同時アクセス時に、あるケースでデッドロックが
　　発生する問題を解決しました。また、ファイルclose時、他のタスクが
　　ファイルアクセス中等でBUSYの場合、BUSYエラーを返していましたが、
　　BUSYが解除されるのを待って、BUSYエラーを返さないようにしました。
（２）ディレクトリ拡張失敗時の後処理に関するバグFIX
　　　メディアフル、または、FAT12/16のrootディレクトリフルで、
　　ディレクトリ拡張を失敗した場合、あるケースで、初期化されて
　　いない情報をアクセスし、メモリデータを壊してしまう問題を
　　解決しました。
　　　また、途中まで書けたロングファイル名がクリアされずに
　　残ってしまう問題を解決しました。
（３）ディレクトリ検索時のI/Oエラーによる無限ループ問題の解決
　　　ディレクトリ検索時にI/Oエラーが発生した場合、ある
　　条件で無限ループとなってしまう問題を解決しました。
（４）ディレクトリrename時の ".."　情報の旧キャッシュ使用問題の解決
　　　GRP_FS_FNAME_CACHEオプションを使用されている場合で、
　　".." の 情報がファイル名称キャッシュに入っているディレクトリ
　　をrenameした場合、同キャッシュがクリアされず、rename後も
　　間違って、古いキャッシュを使って間違ったアクセスが行なわれる
　　問題を解決しました。
（５）O_CREATモード指定時の書込み権限チェックミスの解決
　　　既に存在するファイルに対し、O_CREATモードでopenした場合、
　　書込み権限チェックが正しく行われず、read-onlyファイルでも
　　writeモードでオープンできたり、truncateができる問題を
　　解決しました。
（６）プラットフォーム依存関数のコメントとリターン値の修正
　　　プラットフェーム依存関数grp_fs_mdep_if(_XXX).c　の
　　grp_fs_char_to_unicode, grp_fs_unicode_to_charのコメント
　　の記述ミスを修正しました。
　　　また、grp_fs_get_current_timeについて、コメントおよび
　　ドキュメントでは、正常時には、0をリターン値として返すこと
　　になっているところを時間情報をそのまま返していたため、
　　仕様どおりに変更しました。なお、本リターン値はGR-FILEでは
　　参照していないため、これまでのリターン値のままでも
　　動作上は問題ありません。

　　なお、以上の修正で、Version1.11cに対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.11cと同じです。

    ・grp_file/grp_fs.[ch]
　　・grp_file/fat.c
    ・grp_file/grp_fs_mdep_if[_XXX].c

１.１６　Version 1.11c での変更内容

　Version 1.11b/1.11b1 に対し、以下のバグ修正を行いました。

（１）THREADX対応コードのバグFIX
　　　THREADX用のセマフォア生成処理の再起動時の問題や、THREADX用
　　インクルードファイルの抜けを追加しました
（２）ITRON対応のヘッダファイル内容の変更
　　　ITRON対応のヘッダファイルgrp_itron_id.hの中身を、ポーティング
　　対象であることがわかりやすい内容に変更しました
（３）強制unmountによる強制クローズ状態ファイル処理のバグFIX
　　　オープン中のファイルを、強制unmount処理により、強制クローズ
　　状態とし、さらに、再度mountして、さらに強制unmountした場合、
　　アクセス例外が発生する問題を解決しました
（４）ユーザ外字領域のコード変換不正のバグFIX
　　　ユーザ外字領域のUNICODEコード/SJIS変換が正しく行なわれて
　　いないというバグを修正しました。
（５）ファイルの部分更新時のバグFIX
　　　各ファイルの最終クラスタの先頭からデータを更新した場合、
　　同クラスタの更新した部分以降を0クリアしてしまうというバグ
　　を修正しました

　　なお、以上の修正で、Version1.11b1に対して変更したファイルは、以下の
　ファイルです。その他のファイルは、Version1.11b1と同じです。

    ・grp_mdep/grp_sem.c
    ・grp_mdep/grp_threadx_resource.h
    ・grp_mdep/grp_itron_id.h
  　・grp_file/grp_fs.c
　　・grp_char/grp_char_sjis_conv.c
　　・grp_file/fat.c

１.１７　Version 1.11b/1.11b1 での変更内容

　 Version　1.11/1.11a　に対し、以下のサポート追加とバグ修正を行いました。

（１）１６ビットＣＰＵサポート
　　　１６ビットＣＰＵサポートのため、タイプの見直し変更、演算中の溢れ
　　を防ぐためのタイプキャストの追加等を行いました。
（２）ショート名称ディレクトリ作成時等のファイル名キャッシュの問題
　　　Version 1.11aをGRP_FS_FNAME_CACHEオプション付きでコンパイルした場合で、
　　ショート名称のディレクトリを作成した場合、あるいは、既存のファイルまたは
　　ディレクトリをショート名称のファイル/ディレクトリにrenameした場合、
　　アクセス例外が発生する問題を修正しました。

　なお、以上の修正で、Version1.11aに対して変更したファイルは、以下の
ファイルです。その他のファイルは、Version1.11aと同じです。

    ・grp_file/fat.[ch]
  　・grp_file/grp_fs.[ch]
    ・grp_file/grp_fs_mdep_if.h
    ・grp_file/grp_fs_mdep_if[_XXX].c
    ・grp_file/grp_fs_cfg.h
    ・grp_file/grp_fs_get_disk_part.c
　　・grp_file/grp_fs_io_disk_part.c
　　・grp_file/grp_fs_set_disk_part.c
    ・grp_file/fat_format_def.h
　　・grp_file/grp_fat_format.c
    ・grp_file/grp_fat_format_sd.c
    ・grp_include/grp_fs_if.h
    ・grp_include/grp_mem.h
    ・grp_include/grp_fs_dev_io_if.h
　　・grp_char/grp_char_sjis_conv.c
    ・grp_mem/grp_mem_vl_pool.h
    ・grp_mdep/grp_mem.c
    ・grp_stdio/grp_stdio_fwrite.c
　　・grp_time_lib/grp_time_lib.c

１.１８　Version　1.11/1.11aでの変更内容

　Version 1.10/1.10a に加え、以下の機能を追加しました。

（１）FATファイルシステムのフリークラスタ検索の高速化
　　　・FATファイルシステムのフリークラスタ検索処理部の最適化
　　　　を行い、ファイル生成時のフリークラスタ検索処理時間を
        速くしました。
      ・一時的なI/O領域を使用し、FAT12/16時のマウント時の全フリー
　　　　クラスタ数検索も高速化を可能としました。
　　　　この変更に関連し、上記I/O領域用のパラメータgrp_fs_fat_
　　　　cnt_buf_sz 及びFAT_CNT_BUF_SZを追加しました。また、内部関数
　　　　grp_fs_exec_dev_ioにバッファの種別情報パラメータを追加しました。
（２）GRP_FS_FAT_NO_DIR_SIZE_INFOオプションの追加
　　　・GRP_FS_FAT_NO_DIR_SIZE_INFOオプションを追加し、このオプションを
　　　　指定すると、grp_fs_get_direntの処理において、FATファイルシステム
　　　　では、ディレクトリファイルに対しては、FATのディレクトリエントリ
　　　　の情報のまま、ディレクトリファイルの占有サイズの計算を省略し、
　　　　０で返すようにしました。

   また、以下のバグ修正を行いました。

（３）ファイル管理情報キャッシュブロックサイズが大きい場合の問題
　　　ファイル管理情報キャッシュのブロックサイズが大きく、１ブロック
　　で、先頭領域からFAT領域も超え、データ領域にも跨るような値が指定
　　されていた場合、更新されたデータ領域を古いデータで上書きする
　　可能性があるという問題を修正しました。
（４）FAT12/16のフォーマットのdefaultパラメータの変更
　　　Version 1.10のFAT12/16のdefaultパラメータは、領域の節約という
　　点ではよいのですが、同パラメータでは、データキャッシュのブロック
　　サイズを大きくしても、有効利用できず、性能が得られないという問題
　　があり、同パラメータを変更しました。
（５）FATのオープンファイル情報領域不足時の問題
　　　GR-FILEで設定変更可能パラメータである、オープン中のファイル情報
　　キャッシュ数パラメータをFAT固有のオープンファイル情報領域数パラメータ
　　より大きくした場合、後者の領域が不足し、そのエラー処理が正しくなかった
　　ため、アクセス例外を発生するケースがあるのを修正しました。
　　　この修正に関連して、FAT固有のオープンファイル情報領域数パラメータ
　　（grp_fat_max_open_cnt, FAT_MAX_OPEN）を廃止しました。
（６）強制unmount後のカレントディレクトリアクセス時の問題
　　　カレントディレクトリが設定されている状態で、強制unmount処理を行ない
　　ますと、カレントディレクトリ情報が、無効を示す値に変更されますが、
　　grp_fs_chdirで、その無効状態のカレントディレクトリ情報に対する処理が
　　正しくなく、アクセス例外が発生するという問題を修正しました。　　
（７）可変長メモリ管理ライブラリのセマフォア生成処理の問題
　　　GR-FILEで提供しております可変長メモリ管理ライブラリの初期化処理
　　からコールされるセマフォア生成関数grp_sem_createに対するカウント
　　パラメータが、grp_fs_sem_createと錯覚して間違ったパラメータがわたって
　　しまっていたため、最初のメモリ取得処理のセマフォア取得処理でタイム
　　アウトするという問題があり、その問題を修正しました。また、セマフォア
　　取得処理でタイムアウト等で失敗した場合も、同セマフォアをリリースして
　　しまっているという問題も修正しました。
　　　なお、Version 1.10までは、上記問題により、セマフォアのカウント初期値が
　　0として生成され、最初のメモリ取得要求のセマフォア取得でタイムアウトが
　　発生していたのですが、部分停止等で、ロックがかけられたままでの状況を
　　回避するため、タイムアウトでも、処理を続行する処理が入っていて、かつ、
　　セマフォア取得が失敗していたにも関わらず、セマフォアのリリース処理を
　　行なっていたため、同リリースにより、セマフォアのカウント値が１になり、
　　正しく生成された状況と同じ形となるため、以降のメモリ取得/解放処理は、
　　問題なく動作するという形となっていたため、これまで、問題が発見されない
　　ままとなっていました。
（８）grp_sem.cのThreadX用のコードの問題
　　　grp_sem.cのThreadX用コードで、tx_semaphore_create関数へのパラメータ
　　のタイプのキャスト漏れと、THREADX　ifdefのスペルミスを修正しました。
（９）半角空白を含むファイル名称による無限ループの問題
　　　半角空白を含むファイル名称のファイルを作成/オープンした場合、
　　無限ループに陥るというバグを修正しました。
（10）サイズ０ファイルの扱い方法の問題（以降Version 1.11aにて修正）
　　　サイズ０ファイルの扱いがFATの標準的な方法と異なり、PCで作成
　　したサイズ０ファイルが読めないという問題を修正しました。
（11）FAT32でのルートディレクトリのクラスタ番号の問題
　　　ルート直下のディレクトリの".."ファイルのクラスタ番号をCHKDSK等
　　でエラーとならないようにルートディレクトリの実クラスタ番号から
　　０に変更しました。
（12）ディレクトリサイズ情報の問題
　　　ディレクトリキャッシュオプションを使用した場合、ディレクトリファイル
　　のサイズ情報が０ではなく、実サイズ情報が書き込まれる可能性がある問題を
　　修正しました。

　なお、以上の修正で、Version1.10aに対して変更したファイルは、以下の
７ファイルです。その他のファイルは、Version1.10aと同じです。

　　・grp_file/grp_fs.c, grp_file/grp_fs.h
    ・grp_file/fat.c, grp_file/fat.h
    ・grp_include/grp_fat_format.h
　　・grp_mem/grp_mem_vl_pool.c
　　・grp_mdep/grp_sem.c

２．本CDの構成

 　本CDには、組込み向けファイルシステム（GR-FILE）Version 1.23cの
ドキュメントとソースプログラムが以下のように格納されています。

gr_file_v1.30-160407/
　　README.TXT			本ファイル
　　DIFF_NOTE.TXT		リリース差分内容
　　doc/			GR-FILE関連ドキュメント
　　lib/			GR-FILE作成時のライブラリの格納先ディレクトリ
　　　　　　　　　　　　　　　　（提供時は空）
　　src/			GR-FILE関連ソースプログラム
　　	grp_fs/	
　　	　　base/		GR-FILEライブラリのソース
　　	　　inclide/		GR-FILE関連のインクルードファイル
　　	　　lib/
　　		grp_char/	SJIS-UNICODE変換ライブラリのソース
　　		grp_mem/	可変長メモリ管理ライブラリのソース
　　		grp_stdio/	C言語標準I/Oライブラリ関数のソース
　　		grp_time_lib/	時間ライブラリのソース
　　	mdep_itron/		μITRON依存関数ライブラリのソース
　　	　　base/		μITRON依存のI/O、OS依存関数
　　	　　include/		μITRON依存定義ファイル
　　	　　lib/
　　		grp_mem/	μITRON依存の可変長メモリ管理関数
　　		grp_sem/	μITRON依存のセマフォア関数
　　		grp_time/	ポーティング用時刻関数
　　	mdep_vos/		VOS依存関数ライブラリのソース
　　	　　base/		VOS依存のI/O、OS依存関数
　　	　　include/		VOS依存定義ファイル
　　	　　lib/
　　		grp_mem/	VOS依存の可変長メモリ管理関数
　　		grp_sem/	VOS依存のセマフォア関数
　　		grp_time/	ポーティング用時刻関数
　　	mdep_vos2.xx/		VOS 2.xx依存関数ライブラリのソース
　　	　　base/		VOS 2.xx依存のI/O、OS依存関数
　　	　　include/		VOS 2.xx依存定義ファイル
　　	　　lib/
　　		grp_mem/	VOS 2.xx依存の可変長メモリ管理関数
　　		grp_sem/	VOS 2.xx依存のセマフォア関数
　　		grp_time/	ポーティング用時刻関数
　　	sample/
　　	　　app/		サンプルアプリケーション
　　	　　base/		サンプル関数等

　なお、ソースファイル構成の詳細、及び、GR-FILEライブラリの構築・使用法に
つきましては、上記GR-FILEの説明書の第６章「ソースファイルの構成とGR-FILE
ライブラリの構築・使用法をご覧下さい。
　また、本CDに添付しております、OSの仮想化インタフェースGR-VOSの説明書
GR_VOS_V1.05(FILE).pdfに記述されている以下のファイル名称、外部インタ
フェース関数、型名、定数、変数等は、本バージョンでは、下記のとおり、
読み替えてご利用下さい。(GR-VOSご使用の場合)

　　ファイル名 		gr_vos.h	→	grp_include/grp_vos.h
　　関数/型/定数/定数名 GRVOS_xxxxx	→	GRP_VOS_xxxxx

　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　以上



